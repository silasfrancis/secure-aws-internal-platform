- name: Run PostgreSQL migration on RDS
  hosts: application
  gather_facts: false
  vars:
    sql_dump_path: backend/postgres_db/sql/001_database_dump.sql
    rds_identifier: silas-dev-postgres
    secret_id: basic_secrets
    aws_region: us-east-2

  pre_tasks:
    - name: Update package manager cache
      package:
        update_cache: yes

  tasks:
    - name: Install required packages
      package:
        name:
          - unzip
          - curl
        state: present

    - name: Download AWS CLI v2
      get_url:
        url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
        dest: /tmp/awscliv2.zip
        mode: '0644'

    - name: Unzip AWS CLI installer
      unarchive:
        src: /tmp/awscliv2.zip
        dest: /tmp/
        remote_src: yes

    - name: Install AWS CLI
      command: /tmp/aws/install
      args:
        creates: /usr/local/bin/aws

    - name: Verify AWS CLI installation
      command: aws --version
      register: aws_version
      changed_when: false

    - name: Display AWS CLI version
      debug:
        msg: "{{ aws_version.stdout }}"

    - name: Get RDS endpoint from AWS
      shell: >
        aws rds describe-db-instances
        --db-instance-identifier {{ rds_identifier }}
        --query "DBInstances[0].Endpoint.Address"
        --output text
        --region {{ aws_region }}
      register: rds_host

    - name: Set RDS endpoint fact
      set_fact:
        rds_endpoint: "{{ rds_host.stdout }}"

    - name: Fetch database credentials from Secrets Manager
      shell: >
        aws secretsmanager get-secret-value
        --secret-id {{ secret_id }}
        --query SecretString
        --output text
        --region {{ aws_region }}
      register: db_secret_raw

    - name: Parse DB secrets
      set_fact:
        db_secrets: "{{ db_secret_raw.stdout | from_json }}"

    - name: Ensure PostgreSQL client is installed
      package:
        name: postgresql-client
        state: present
      become: true

    - name: Copy SQL dump to temporary location
      copy:
        src: "{{ sql_dump_path }}"
        dest: /tmp/dump.sql
        mode: '0644'

    - name: Run PostgreSQL migration on RDS
      shell: >
        PGPASSWORD={{ db_secrets.DB_PASSWORD }}
        psql -h {{ rds_endpoint }}
             -U {{ db_secrets.DB_USER }}
             -d {{ db_secrets.DB_NAME | default('postgres') }}
             -f /tmp/dump.sql
      environment:
        PGHOST: "{{ rds_endpoint }}"
        PGUSER: "{{ db_secrets.DB_USER }}"
        PGPASSWORD: "{{ db_secrets.DB_PASSWORD }}"
      register: migration_result

    - name: Show migration output
      debug:
        var: migration_result.stdout
